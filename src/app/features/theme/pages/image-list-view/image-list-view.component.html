<div class="content">
  <div class="content-header">
    <div class="header-left col-4">
      @if (store.themeDatasetList() && store.themeDatasetList().length > 1) {
        <select
          class="list-select"
          [compareWith]="store.compareDataset"
          [ngModel]="store.useDataset()"
          [matTooltip]="'themeDataset.selectDataset' | translate"
          (ngModelChange)="store.changeDataset($event)">
          @for (dataset of store.themeDatasetList(); track dataset.seq) {
            <option [ngValue]="dataset">
              {{ dataset.label }}
            </option>
          }
        </select>
      }
      @if (
        store.themeTagListForSelect() &&
        store.themeTagListForSelect().length > 1
      ) {
        <select
          class="list-select"
          [compareWith]="store.compareShareTag"
          [ngModel]="store.useShareTag()"
          [matTooltip]="'themeTag.selectTag' | translate"
          (ngModelChange)="store.changeShareTag($event)">
          @for (tag of store.themeTagListForSelect(); track tag.shareTagId) {
            <option [ngValue]="tag">
              {{ store.shareTagNameMap()[tag.shareTagId] || tag.shareTagId }}
              {{
                tag.seq === -1
                  ? ''
                  : '(' + store.getTagValueLength(tag.shareTagId) + ')'
              }}
            </option>
          }
        </select>
      }
      <button
        class="d-flex"
        mat-icon-button
        [matTooltip]="'g.refresh' | translate"
        (click)="store.onRefresh()">
        <mat-icon>loop</mat-icon>
      </button>
    </div>
    <div class="header-center col-4">
      <div class="d-flex">
        <input
          type="text"
          class="form-control"
          [matAutocomplete]="auto"
          [ngModel]="store.searchValue()"
          (ngModelChange)="store.searchValue.set($event)"
          (keydown.enter)="store.onSearch(store.searchValue())" />
        <mat-autocomplete
          #auto="matAutocomplete"
          (optionSelected)="store.onSearch($event.option.value)">
          @for (option of store.filterAutoCompleteList(); track option) {
            <mat-option [value]="option">{{ option }}</mat-option>
          }
        </mat-autocomplete>
        @if (store.autoCompleteList().length > 0) {
          <button
            mat-icon-button
            class="d-flex"
            [matTooltip]="'g.popupSelect' | translate"
            (click)="store.selectMultipleValue()">
            <mat-icon class="material-icons-outlined"
              ><span class="material-symbols-outlined">
                select_window_2
              </span></mat-icon
            >
          </button>
        }
        <button
          mat-icon-button
          class="d-flex"
          [matTooltip]="'g.clear' | translate"
          (click)="store.onSearch('')">
          <mat-icon>clear</mat-icon>
        </button>
        <button
          mat-icon-button
          class="d-flex"
          [matTooltip]="'g.search' | translate"
          (click)="store.onSearch(store.searchValue())">
          <mat-icon>search</mat-icon>
        </button>
        @if (store.defaultKey() !== '') {
          <button
            mat-icon-button
            class="d-flex"
            [matTooltip]="'g.random' | translate"
            (click)="store.randomSearch()">
            <mat-icon>shuffle</mat-icon>
          </button>
        }
      </div>
    </div>
    <div class="header-right col-4">
      <ng-container *ngTemplateOutlet="headerRight"></ng-container>
    </div>
  </div>
  <div class="d-flex mb-2">
    <app-top-custom-buttons
      [themeTopCustomList]="store.themeTopCustomList()"
      [headerId]="store.headerId()"
      [type]="store.themeHeaderType()"
      [topCustomValueMap]="
        store.topCustomValueMap.value()
      "></app-top-custom-buttons>
  </div>
  <div class="list-content">
    <div class="py-2">
      {{ 'g.totalNum' | translate }}: {{ store.totalLength() }}
    </div>
    <ng-container *ngTemplateOutlet="dataListRef"></ng-container>
  </div>
  <div class="content-footer">
    <div class="footer-left col-4"></div>
    <div class="footer-center col-4"></div>
    <div class="footer-right col-4">
      <ng-container *ngTemplateOutlet="headerRight"></ng-container>
    </div>
  </div>
</div>

<ng-template #headerRight>
  @if (store.sortArray().length > 0) {
    <select
      class="list-select"
      [matTooltip]="'g.sort' | translate"
      [compareWith]="store.compareSort"
      [ngModel]="store.sortValue()"
      (ngModelChange)="changeSort($event)">
      @for (sort of store.sortArray(); track sort.key) {
        <option [ngValue]="sort">
          {{ sort.label }}
        </option>
      }
    </select>
    <div class="d-flex flex-column justify-content-center">
      <mat-icon class="sortAsc" (click)="changeAsc()">{{
        this.store.ascFlag() ? 'keyboard_arrow_down' : 'keyboard_arrow_up'
      }}</mat-icon>
    </div>
  }
  @if (store.pages().length > 1) {
    <select
      class="list-select"
      [ngModel]="store.currentPage()"
      (ngModelChange)="changePage($event)">
      @for (page of store.pages(); track page) {
        <option [ngValue]="page">{{ page }} {{ 'g.page' | translate }}</option>
      }
    </select>
    <div class="d-flex flex-column justify-content-center" style="height: 34px">
      @if (store.currentPage() !== 1 && store.pages().length !== 1) {
        <mat-icon
          class="prePage"
          (click)="store.prePage()"
          [matTooltip]="'g.prePage' | translate"
          >keyboard_arrow_up</mat-icon
        >
      }
      @if (
        store.currentPage() !== store.pages().length &&
        store.pages().length !== 1
      ) {
        <mat-icon
          class="nextPage"
          (click)="store.nextPage()"
          [matTooltip]="'g.nextPage' | translate"
          >keyboard_arrow_down</mat-icon
        >
      }
    </div>
  }
</ng-template>
<ng-template #dataListRef>
  @for (
    data of store.viewData();
    track store.defaultKey() ? data[store.defaultKey()] : $index;
    let i = $index
  ) {
    <div
      class="d-flex card"
      (mouseenter)="store.hoveredIndex.set(i)"
      (mouseleave)="store.hoveredIndex.set(-1)">
      <div class="card-body">
        <app-img-content
          class="img-content"
          [url]="getImageUrl(data)"
          [priority]="i === 0"
          [ctrlPressed]="ctrlPressed()"
          [refreshDate]="store.refreshDate()"
          (hiddenFixedImage)="fixedImage.closeModal()"
          (visibleFixedImage)="fixedImage.show()"
          (changeFixedImagePath)="
            store.fixedImagePath.set($event)
          "></app-img-content>
        <div class="detail-content">
          <div class="edit-button">
            @if (store.hoveredIndex() === i) {
              @if (store.themeOtherSetting()?.useQuickRefresh) {
                <button
                  class="d-flex"
                  mat-icon-button
                  [matTooltip]="'themeDataset.quickRefresh' | translate"
                  (click)="quickRefresh(data)">
                  <mat-icon class="material-icons-outlined"
                    ><span class="material-symbols-outlined">
                      refresh
                    </span></mat-icon
                  >
                </button>
              }
              <button
                class="d-flex"
                mat-icon-button
                [matTooltip]="'themeDataset.editData' | translate"
                (click)="store.openEditData(data)">
                <mat-icon class="material-icons-outlined"
                  ><span class="material-symbols-outlined">
                    edit
                  </span></mat-icon
                >
              </button>
            }
          </div>

          <div class="detail-rows scrollbar-primary">
            @for (
              label of store.visibleLabelList();
              track label.byKey;
              let idx = $index
            ) {
              @if (
                label.isVisible &&
                checkValueVisible(data[label.byKey]) &&
                checkVisibleByDataset(label)
              ) {
                <div class="detail-row">
                  <div class="row-label">{{ label.label }}</div>
                  <app-list-item-value
                    [data]="data"
                    [themeLabel]="label"
                    [isHover]="store.hoveredIndex() === i"
                    [seqKey]="store.seqKey()"
                    (searchChange)="
                      store.onSearch($event)
                    "></app-list-item-value>
                </div>
              }
            }
            @if (store.themeTagList().length > 0) {
              <div class="detail-row">
                <div class="row-label">{{ 'g.tag' | translate }}</div>
                <app-item-tag-buttons
                  [value]="data[store.defaultKey()]"
                  [data]="getData(data)"
                  [themeTagList]="store.themeTagList()"
                  [shareTagValueMap]="store.shareTagValueMap()"
                  (tagValueUpdate)="tagValueUpdate($event)"
                  [shareTagNameMap]="
                    store.shareTagNameMap()
                  "></app-item-tag-buttons>
              </div>
            }
          </div>

          @if (store.defaultKey() && store.themeCustomList().length > 0) {
            <div class="buttons-panel">
              <app-custom-buttons
                [themeCustomList]="store.themeCustomList()"
                [data]="data"
                [headerId]="store.headerId()"
                [defaultKey]="store.defaultKey()"
                [customValueMap]="store.customValueMap.value()"
                [fileExist]="store.fileExistResource.value()"
                [themeHeaderType]="store.themeHeaderType()"
                [currentDatasetName]="
                  store.useDataset().label
                "></app-custom-buttons>
            </div>
          }
        </div>
      </div>
    </div>
  }
</ng-template>

<app-scrollTop></app-scrollTop>
<app-fixed-image
  #fixedImage
  [fixedImagePath]="store.fixedImagePath()"></app-fixed-image>
