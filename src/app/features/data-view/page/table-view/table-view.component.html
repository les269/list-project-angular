<div class="mt-3">
  <div class="d-flex mb-2 mx-4">
    <div class="d-flex col-4">
      @if (store.themeDatasetList().length > 1) {
        <select
          class="form-select"
          [compareWith]="store.compareDataset"
          [ngModel]="store.useDataset()"
          [matTooltip]="'themeDataset.selectDataset' | translate"
          (ngModelChange)="store.changeDataset($event)">
          @for (dataset of store.themeDatasetList(); track $index) {
            <option [ngValue]="dataset">
              {{ dataset.label }}
            </option>
          }
        </select>
      }
      @if (
        store.themeTagListForSelect() &&
        store.themeTagListForSelect().length > 1
      ) {
        <select
          class="form-select"
          [compareWith]="store.compareShareTag"
          [ngModel]="store.useShareTag()"
          [matTooltip]="'themeTag.selectTag' | translate"
          (ngModelChange)="store.changeShareTag($event)">
          @for (tag of store.themeTagListForSelect(); track tag.shareTagId) {
            <option [ngValue]="tag">
              {{ store.shareTagNameMap()[tag.shareTagId] || tag.shareTagId }}
              {{
                tag.seq === -1
                  ? ''
                  : '(' + store.getTagValueLength(tag.shareTagId) + ')'
              }}
            </option>
          }
        </select>
      }
      <button
        class="d-flex"
        mat-icon-button
        [matTooltip]="'g.refresh' | translate"
        (click)="store.onRefresh()">
        <mat-icon>loop</mat-icon>
      </button>
    </div>
    <div class="d-flex col-4">
      <input
        type="text"
        class="form-control"
        [matAutocomplete]="auto"
        [ngModel]="store.searchValue()"
        (ngModelChange)="store.searchValue.set($event)"
        (keydown.enter)="store.onSearch(store.searchValue())" />
      <mat-autocomplete
        #auto="matAutocomplete"
        (optionSelected)="store.onSearch($event.option.value)">
        @for (option of store.filterAutoCompleteList(); track option) {
          <mat-option [value]="option">{{ option }}</mat-option>
        }
      </mat-autocomplete>
      <button
        mat-icon-button
        class="d-flex"
        [matTooltip]="'g.popupSelect' | translate"
        (click)="store.selectMultipleValue()">
        <mat-icon class="material-icons-outlined"
          ><span class="material-symbols-outlined">
            select_window_2
          </span></mat-icon
        >
      </button>
      <button
        mat-icon-button
        class="d-flex"
        [matTooltip]="'g.clear' | translate"
        (click)="store.onSearch('')">
        <mat-icon>clear</mat-icon>
      </button>
      <button
        mat-icon-button
        class="d-flex"
        [matTooltip]="'g.search' | translate"
        (click)="store.onSearch(store.searchValue())">
        <mat-icon>search</mat-icon>
      </button>
    </div>
    <div class="d-flex col-4 justify-content-end">
      <!-- @if (store.defaultKey() && store.themeOtherSetting()?.showDuplicate) {
        <button mat-button (click)="showDuplicate()">
          {{ 'themeTopCustom.showDuplicate' | translate }}
        </button>
      } -->
      @if (store.defaultKey() && store.themeCustomList().length > 0) {
        <button mat-button (click)="isExpand.set(!isExpand())">
          {{ 'themeCustom.showCustomButton' | translate }}
        </button>
      }
    </div>
  </div>
  <div class="d-flex mb-2 mx-4">
    <app-top-custom-buttons
      [themeTopCustomList]="store.themeTopCustomList()"
      [headerId]="store.headerId()"
      [type]="store.themeHeaderType()"
      [topCustomValueMap]="
        store.topCustomValueMap.value()
      "></app-top-custom-buttons>
  </div>
  <mat-paginator
    class="mat-paginator"
    [pageIndex]="store.currentPage() - 1"
    [length]="store.filterData().length"
    [pageSize]="store.pageSize()"
    [showFirstLastButtons]="true"
    hidePageSize
    (page)="onPageChange($event)"></mat-paginator>
  <table
    mat-table
    [dataSource]="dataSource()"
    multiTemplateDataRows
    matSort
    (matSortChange)="onSortChange($event)">
    @for (label of store.visibleLabelList(); track label.byKey) {
      @let key = label.byKey;
      <ng-container [matColumnDef]="key">
        <th
          mat-header-cell
          *matHeaderCellDef
          [mat-sort-header]="key"
          [disabled]="!label.isSort">
          {{ label.label }}
        </th>
        <td
          mat-cell
          *matCellDef="let element"
          [ngStyle]="{
            width: getWidth(label, 'width'),
            'max-width': getWidth(label, 'maxWidth'),
            'min-width': getWidth(label, 'minWidth'),
            'border-bottom': isExpand() ? 'none' : 'solid #ccc 1px',
          }">
          <app-list-item-value
            [themeLabel]="label"
            [data]="element"
            [isHover]="true"
            [seqKey]="store.seqKey()"
            (searchChange)="store.onSearch($event)"></app-list-item-value>
        </td>
        <td mat-footer-cell *matFooterCellDef>
          @switch (label.type) {
            @case ('fileSize') {
              {{ fileSizeTotal(key) | fileSize }}
            }
          }
        </td>
      </ng-container>
    }

    <ng-container matColumnDef="other">
      <th mat-header-cell *matHeaderCellDef>&nbsp;</th>
      <td
        mat-cell
        *matCellDef="let element; let i = dataIndex"
        [ngStyle]="{
          'border-bottom': isExpand() ? 'none' : 'solid #ccc 1px',
        }">
        <div class="row flex-nowrap">
          <button
            class="d-flex"
            mat-icon-button
            [matTooltip]="'themeDataset.editData' | translate"
            (click)="store.openEditData(element)">
            <mat-icon class="material-icons-outlined"
              ><span class="material-symbols-outlined"> edit </span></mat-icon
            >
          </button>
        </div>
      </td>
      <td mat-footer-cell *matFooterCellDef></td>
    </ng-container>
    <ng-container matColumnDef="expanded">
      <td
        mat-cell
        *matCellDef="let element; let i = dataIndex"
        [attr.colspan]="displayedColumns().length"
        [ngStyle]="{
          'border-bottom': isExpand() ? 'solid #ccc 1px' : 'none',
          'border-top': 'none',
        }">
        @if (isExpand()) {
          <div animate.enter="expanded-in" animate.leave="expanded-out">
            @if (store.themeTagList().length > 0) {
              <div class="mb-2">
                <app-item-tag-buttons
                  [value]="element[store.defaultKey()]"
                  [data]="element"
                  [themeTagList]="store.themeTagList()"
                  [shareTagValueMap]="store.shareTagValueMap()"
                  (tagValueUpdate)="store.tagValueUpdate($event)"
                  [shareTagNameMap]="
                    store.shareTagNameMap()
                  "></app-item-tag-buttons>
              </div>
            }
            @if (store.themeHeader.value()) {
              <div class="mb-2">
                <app-custom-buttons
                  [themeCustomList]="store.themeCustomList()"
                  [data]="element"
                  [headerId]="store.headerId()"
                  [defaultKey]="store.defaultKey()"
                  [customValueMap]="store.customValueMap.value()"
                  [fileExist]="store.fileExistResource.value()"
                  [currentDatasetName]="
                    store.useDataset().label
                  "></app-custom-buttons>
              </div>
            }
          </div>
        }
      </td>
    </ng-container>
    <tr
      class="mat-header-row"
      mat-header-row
      *matHeaderRowDef="displayedColumns()"></tr>
    <tr
      mat-row
      *matRowDef="let row; columns: displayedColumns()"
      class="mat-row"
      [ngStyle]="{
        'border-bottom': isExpand() ? 'none' : 'solid #ccc 1px',
      }"
      [style.backgroundColor]="row[COLOR_KEY] || ''"></tr>
    <tr
      mat-row
      *matRowDef="let row; columns: ['expanded']"
      style="height: 0px"
      [style.backgroundColor]="row[COLOR_KEY] || ''"></tr>
    <tr mat-footer-row *matFooterRowDef="displayedColumns()"></tr>
  </table>
</div>
<app-scrollTop></app-scrollTop>
